pipeline {
    agent any
    stages {
        stage('Verificar Repositório') {
            steps {
                checkout([$class: 'GitSCM', branches: [[name: '*/main']], useRemoteConfigs: [[url: 'https://github.com/Gustasilvadev/getmoney-ControleFinanceiro']]])
            }
        }

        stage('Construir APK React Native') {
            agent {
                docker {
                    image 'node:18-alpine'
                }
            }
            steps {
                script {
                    sh 'npm install'
                    sh 'npm install -g @expo/eas-cli'
                    sh 'eas build --platform android --profile production --non-interactive --local'
                    sh 'mkdir -p apk'
                    sh 'cp *.apk apk/getmoney.apk'
                }
            }
        }

        stage('Instalar Dependências Backend') {
            steps {
                script {
                    dir('getmoneyBackend') {
                        sh 'mvn clean install -DskipTests'
                    }
                }
            }
        }

        stage('Preparar APK para Docker') {
            steps {
                script {
                    dir('getmoneyBackend') {
                        sh 'cp ../apk/getmoney.apk .'
                        sh 'ls -la getmoney.apk'
                    }
                }
            }
        }

         stage('Construir Imagem Docker') {
            steps {
                script {
                    def appName = 'getmoney'
                    def imageTag = "${appName}:${env.BUILD_ID}"

                    dir('getmoneyBackend') {
                        sh "docker build -t ${imageTag} ."
                    }
                }
            }
        }

        stage('Fazer Deploy') {
            steps {
                script {
                    def appName = 'getmoney'
                    def imageTag = "${appName}:${env.BUILD_ID}"

                    sh "docker stop ${appName} || exit 0"
                    sh "docker rm -v ${appName} || exit 0"

                    sh "docker run -d --name ${appName} -p 8401:8401 ${imageTag}"
                }
            }
        }
    }

    post {
        success {
            echo 'Deploy realizado com sucesso!'
            echo 'APK disponível em: http://localhost:8401/install'
        }
        failure {
            echo 'Houve um erro durante o deploy.'
        }
    }
}